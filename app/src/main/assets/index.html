<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>סטטיסטיקת הגרלות</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, 'Segoe UI', Roboto, sans-serif;
    background: #f5f5f5;
    color: #333;
    font-size: 14px;
    -webkit-text-size-adjust: none;
}
.header {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #fff;
    padding: 16px;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.header h1 { font-size: 20px; margin-bottom: 4px; }
.header .subtitle { font-size: 12px; color: #aaa; }
.search-bar {
    padding: 12px 16px;
    background: #fff;
    border-bottom: 1px solid #e0e0e0;
    position: sticky;
    top: 60px;
    z-index: 99;
    display: flex;
    gap: 8px;
    align-items: center;
}
.search-bar input {
    flex: 1;
    padding: 10px 14px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 16px;
    font-family: inherit;
    background: #f8f9fa;
    text-align: right;
    direction: ltr;
}
.search-bar input:focus { outline: none; border-color: #e94560; background: #fff; }
.search-btn {
    padding: 10px 20px;
    background: #e94560;
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: bold;
    white-space: nowrap;
    cursor: pointer;
}
.search-btn:active { background: #c62828; }
.reset-btn {
    padding: 10px 14px;
    background: #607D8B;
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 13px;
    white-space: nowrap;
    cursor: pointer;
    display: none;
}
.reset-btn.visible { display: block; }
.stats-bar {
    display: flex;
    justify-content: space-around;
    padding: 10px 16px;
    background: #fff;
    border-bottom: 1px solid #e0e0e0;
}
.stat { text-align: center; }
.stat .num { font-size: 18px; font-weight: bold; color: #e94560; }
.stat .label { font-size: 11px; color: #888; }
.table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
table {
    width: 100%;
    border-collapse: collapse;
    min-width: 500px;
}
th {
    background: #16213e;
    color: #fff;
    padding: 10px 8px;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
    text-align: center;
    cursor: pointer;
    user-select: none;
}
th:active { background: #0f3460; }
th .sort-arrow { font-size: 10px; margin-right: 2px; }
td {
    padding: 10px 8px;
    text-align: center;
    font-size: 13px;
    border-bottom: 1px solid #f0f0f0;
    white-space: nowrap;
}
tr:nth-child(even) td { background: #fafafa; }
.series-cell {
    font-weight: bold;
    color: #1a1a2e;
    font-size: 14px;
    letter-spacing: 1px;
    direction: ltr;
}
.loading {
    text-align: center;
    padding: 60px 20px;
    color: #999;
}
.loading .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e0e0e0;
    border-top-color: #e94560;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 15px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.error {
    text-align: center;
    padding: 40px 20px;
    color: #e94560;
}
.error .retry-btn {
    display: inline-block;
    margin-top: 15px;
    padding: 10px 30px;
    background: #e94560;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 14px;
}
.pager {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: #fff;
    border-top: 1px solid #e0e0e0;
}
.pager button {
    padding: 8px 20px;
    background: #16213e;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 13px;
}
.pager button:disabled { background: #ccc; }
.pager .info { font-size: 13px; color: #666; }

/* Series detail view */
.detail-card {
    margin: 16px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    overflow: hidden;
}
.detail-header {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #fff;
    padding: 16px 20px;
    text-align: center;
}
.detail-header .series-name {
    font-size: 28px;
    font-weight: bold;
    letter-spacing: 3px;
    direction: ltr;
    color: #e94560;
}
.detail-header .series-label {
    font-size: 13px;
    color: #aaa;
    margin-top: 4px;
}
.detail-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1px;
    background: #e0e0e0;
}
.detail-stat {
    background: #fff;
    padding: 14px;
    text-align: center;
}
.detail-stat .num {
    font-size: 20px;
    font-weight: bold;
    color: #1a1a2e;
}
.detail-stat .label {
    font-size: 11px;
    color: #888;
    margin-top: 2px;
}
.detail-section {
    padding: 16px 20px;
}
.detail-section h3 {
    font-size: 15px;
    color: #1a1a2e;
    margin-bottom: 12px;
    padding-bottom: 6px;
    border-bottom: 2px solid #e94560;
}
.perm-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    margin-bottom: 6px;
    background: #f8f9fa;
    border-radius: 8px;
}
.perm-name {
    font-weight: bold;
    font-size: 16px;
    letter-spacing: 2px;
    direction: ltr;
    color: #1a1a2e;
}
.perm-count {
    display: flex;
    align-items: center;
    gap: 8px;
}
.perm-count .num {
    font-weight: bold;
    font-size: 16px;
    color: #e94560;
}
.perm-count .label {
    font-size: 11px;
    color: #888;
}
.perm-bar {
    width: 80px;
    height: 6px;
    background: #e0e0e0;
    border-radius: 3px;
    overflow: hidden;
}
.perm-bar-fill {
    height: 100%;
    background: #e94560;
    border-radius: 3px;
}
</style>
</head>
<body>

<div class="header">
    <h1>סטטיסטיקת הגרלות</h1>
    <div class="subtitle">טבלת סיכום סדרות</div>
</div>

<div class="search-bar">
    <input type="text" id="searchInput" placeholder="חיפוש סדרה..." onkeydown="if(event.key==='Enter'){doSearch();this.blur();}">
    <button class="search-btn" onclick="doSearch()">חפש</button>
    <button class="reset-btn" id="resetBtn" onclick="resetSearch()">הכל</button>
</div>

<div class="stats-bar" id="statsBar" style="display:none;">
    <div class="stat"><div class="num" id="statTotal">-</div><div class="label">סדרות</div></div>
    <div class="stat"><div class="num" id="statRows">-</div><div class="label">שורות מקור</div></div>
    <div class="stat"><div class="num" id="statLast">-</div><div class="label">הגרלה אחרונה</div></div>
</div>

<div id="content">
    <div class="loading"><div class="spinner"></div><div>טוען נתונים...</div></div>
</div>

<script>
var allData = [];
var allDetails = [];
var filteredData = [];
var currentPage = 0;
var pageSize = 50;
var sortCol = 'total';
var sortDir = -1;
var apiUrl = 'http://172.236.22.5/130API.php';
var isSearchMode = false;

loadData();

function loadData() {
    document.getElementById('content').innerHTML = '<div class="loading"><div class="spinner"></div><div>טוען נתונים...</div></div>';
    document.getElementById('statsBar').style.display = 'none';

    fetch(apiUrl)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) throw new Error(data.error);
            allData = data.summary || [];
            allDetails = data.details || [];
            document.getElementById('statTotal').textContent = allData.length;
            document.getElementById('statRows').textContent = data.totalRows || '-';
            document.getElementById('statLast').textContent = data.lastDraw || '-';
            document.getElementById('statsBar').style.display = 'flex';
            filteredData = allData.slice();
            sortData();
            renderTable();
        })
        .catch(function(err) {
            document.getElementById('content').innerHTML =
                '<div class="error">שגיאה בטעינת נתונים<br><small>' + err.message + '</small>' +
                '<br><button class="retry-btn" onclick="loadData()">נסה שוב</button></div>';
        });
}

function doSearch() {
    var q = document.getElementById('searchInput').value.trim().toUpperCase();
    if (!q) {
        resetSearch();
        return;
    }

    // Find exact match first
    var exact = allData.find(function(r) { return String(r.series).toUpperCase() === q; });

    if (exact) {
        // Show detailed view for this series
        isSearchMode = true;
        document.getElementById('resetBtn').classList.add('visible');
        renderSeriesDetail(exact);
    } else {
        // Filter table by partial match
        isSearchMode = true;
        document.getElementById('resetBtn').classList.add('visible');
        filteredData = allData.filter(function(r) {
            return String(r.series).toUpperCase().indexOf(q) !== -1;
        });

        if (filteredData.length === 1) {
            // Only one result - show detail view
            renderSeriesDetail(filteredData[0]);
        } else {
            sortData();
            currentPage = 0;
            renderTable();
        }
    }
}

function resetSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('resetBtn').classList.remove('visible');
    isSearchMode = false;
    filteredData = allData.slice();
    sortData();
    currentPage = 0;
    renderTable();
}

function renderSeriesDetail(series) {
    var seriesPerms = allDetails.filter(function(d) {
        return String(d.series) === String(series.series);
    });

    // Sort perms by count descending
    seriesPerms.sort(function(a, b) { return b.count - a.count; });

    var maxCount = seriesPerms.length > 0 ? seriesPerms[0].count : 1;

    var html = '<div class="detail-card">';

    // Header
    html += '<div class="detail-header">';
    html += '<div class="series-name">' + series.series + '</div>';
    html += '<div class="series-label">סיכום סדרה</div>';
    html += '</div>';

    // Stats grid
    html += '<div class="detail-stats">';
    html += '<div class="detail-stat"><div class="num">' + series.total + '</div><div class="label">סך הופעות</div></div>';
    html += '<div class="detail-stat"><div class="num">' + (series.last !== null ? series.last : '-') + '</div><div class="label">הופעה אחרונה</div></div>';
    html += '<div class="detail-stat"><div class="num">' + (series.before !== null ? series.before : '-') + '</div><div class="label">לפני אחרונה</div></div>';
    html += '<div class="detail-stat"><div class="num">' + (series.gap !== null ? series.gap : '-') + '</div><div class="label">פער</div></div>';
    html += '<div class="detail-stat"><div class="num">' + (series.stay !== null ? series.stay : '-') + '</div><div class="label">שהייה</div></div>';
    html += '<div class="detail-stat"><div class="num">' + seriesPerms.length + '</div><div class="label">כיוונים</div></div>';
    html += '</div>';

    // Permutations
    html += '<div class="detail-section">';
    html += '<h3>כיוונים (' + seriesPerms.length + ')</h3>';

    for (var i = 0; i < seriesPerms.length; i++) {
        var p = seriesPerms[i];
        var pct = Math.round(p.count / maxCount * 100);
        html += '<div class="perm-row">';
        html += '<div class="perm-name">' + p.perm + '</div>';
        html += '<div class="perm-count">';
        html += '<div class="perm-bar"><div class="perm-bar-fill" style="width:' + pct + '%"></div></div>';
        html += '<div class="num">' + p.count + '</div>';
        html += '<div class="label">הופעות</div>';
        html += '</div>';
        html += '</div>';
    }

    html += '</div>'; // detail-section
    html += '</div>'; // detail-card

    document.getElementById('content').innerHTML = html;
}

function sortData() {
    var col = sortCol;
    var dir = sortDir;
    filteredData.sort(function(a, b) {
        var va = a[col], vb = b[col];
        if (va === null) va = -9999999;
        if (vb === null) vb = -9999999;
        if (col === 'series') return dir * String(va).localeCompare(String(vb));
        return dir * (va - vb);
    });
}

function doSort(col) {
    if (sortCol === col) { sortDir *= -1; }
    else { sortCol = col; sortDir = -1; }
    sortData();
    currentPage = 0;
    renderTable();
}

function renderTable() {
    var start = currentPage * pageSize;
    var end = Math.min(start + pageSize, filteredData.length);
    var page = filteredData.slice(start, end);
    var totalPages = Math.ceil(filteredData.length / pageSize);

    var cols = [
        { key: 'series', label: 'סדרה' },
        { key: 'total', label: 'סך הופעות' },
        { key: 'last', label: 'הופעה אחרונה' },
        { key: 'before', label: 'לפני אחרונה' },
        { key: 'gap', label: 'פער' },
        { key: 'stay', label: 'שהייה' }
    ];

    var html = '<div class="table-container"><table><thead><tr>';
    for (var i = 0; i < cols.length; i++) {
        var arrow = '';
        if (sortCol === cols[i].key) arrow = '<span class="sort-arrow">' + (sortDir === -1 ? '▼' : '▲') + '</span>';
        html += '<th onclick="doSort(\'' + cols[i].key + '\')">' + arrow + cols[i].label + '</th>';
    }
    html += '</tr></thead><tbody>';

    for (var j = 0; j < page.length; j++) {
        var r = page[j];
        html += '<tr onclick="viewSeries(\'' + r.series + '\')" style="cursor:pointer;">';
        html += '<td class="series-cell">' + r.series + '</td>';
        html += '<td>' + r.total + '</td>';
        html += '<td>' + (r.last !== null ? r.last : '-') + '</td>';
        html += '<td>' + (r.before !== null ? r.before : '-') + '</td>';
        html += '<td>' + (r.gap !== null ? r.gap : '-') + '</td>';
        html += '<td>' + (r.stay !== null ? r.stay : '-') + '</td>';
        html += '</tr>';
    }

    if (page.length === 0) {
        html += '<tr><td colspan="6" style="padding:30px;color:#999;">לא נמצאו תוצאות</td></tr>';
    }

    html += '</tbody></table></div>';

    html += '<div class="pager">';
    html += '<button onclick="prevPage()"' + (currentPage <= 0 ? ' disabled' : '') + '>הקודם</button>';
    html += '<span class="info">' + (currentPage + 1) + ' / ' + Math.max(totalPages, 1) + ' (' + filteredData.length + ' סדרות)</span>';
    html += '<button onclick="nextPage()"' + (end >= filteredData.length ? ' disabled' : '') + '>הבא</button>';
    html += '</div>';

    document.getElementById('content').innerHTML = html;
}

function viewSeries(seriesName) {
    var s = allData.find(function(r) { return String(r.series) === String(seriesName); });
    if (s) {
        document.getElementById('searchInput').value = seriesName;
        document.getElementById('resetBtn').classList.add('visible');
        isSearchMode = true;
        renderSeriesDetail(s);
        window.scrollTo(0, 0);
    }
}

function prevPage() {
    if (currentPage > 0) { currentPage--; renderTable(); window.scrollTo(0, 0); }
}
function nextPage() {
    var totalPages = Math.ceil(filteredData.length / pageSize);
    if (currentPage < totalPages - 1) { currentPage++; renderTable(); window.scrollTo(0, 0); }
}
</script>
</body>
</html>
